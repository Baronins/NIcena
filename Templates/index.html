<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>NICena</title>
    <!-- Load Leaflet CSS library -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY=" crossorigin="" />
    <!-- Load Leaflet.markercluster CSS -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster/dist/MarkerCluster.css" />
    <link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster/dist/MarkerCluster.Default.css" />
    <!-- Load custom CSS styles -->
    <link rel="stylesheet" href="{{ url_for('static', filename='styles.css') }}">
</head>
<body>
    <div class="container">
        <div class="title">
            <h1>NICena</h1>
            <h2>Nekustamo īpašumu darījumu dati</h2>
        </div>
        <!-- Empty space -->
        <div class="spacer"></div>
        <!-- Navigation container -->
        <div class="navigation">
            <!-- Page links -->
            <div class="nav-link"><a href="/dati">Dati</a></div>
            <div class="nav-link"><a href="/vērtējums">Vērtējums</a></div>
            <div class="nav-link"><a href="/info">Info</a></div>
        </div>
        <!-- Empty space -->
        <div class="spacer"></div>
    </div>

    <!-- Map container -->
    <div id="map-container" class="map-container">
        <div id="map" style="width: 100%; height: 100%;"></div>
    </div>

<!-- Load Leaflet JavaScript library -->
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

<!-- Load JawgMaps tile layer -->
<script>
    // Create a map centered around Riga with appropriate zoom level
    var map = L.map('map').setView([56.9496, 24.1052], 13); // Riga coordinates: [56.9496, 24.1052]

    // Add JawgMaps tile layer
    var access_token = 'l7WnYRIQY2jKnYplkIqR3KzuU2tmE7133B1M8h7B8BUGYmj4llQZr0a2nGaXEeXB';
    var jawgMapsLayer = L.tileLayer('https://tile.jawg.io/jawg-matrix/{z}/{x}/{y}{r}.png?access-token=' + access_token, {
        maxZoom: 22,
        attribution: '<a href="https://jawg.io" title="Tiles Courtesy of Jawg Maps" target="_blank">&copy; <b>Jawg</b>Maps</a> &copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors'
    }).addTo(map);

    // Center the map
    map.setView([56.9496, 24.1052]); // Riga coordinates: [56.9496, 24.1052]

    // Add markers and lines between them
    try {
        var latitudeData = {{ latitude | tojson | safe }};
        var longitudeData = {{ longitude | tojson | safe }};
        var namesData = {{ names | tojson | safe }};
        var priceData = {{ price | tojson | safe }};

        // Check if latitude, longitude, names, and price data are arrays
        if (Array.isArray(latitudeData) && Array.isArray(longitudeData) && Array.isArray(namesData) && Array.isArray(priceData)) {
            // Check if all arrays have the same length
            if (latitudeData.length === longitudeData.length && latitudeData.length === namesData.length && latitudeData.length === priceData.length) {
                var markers = [];

                for (var i = 0; i < latitudeData.length; i++) {
                    var latitude = parseFloat(latitudeData[i]);
                    var longitude = parseFloat(longitudeData[i]);
                    var name = namesData[i];
                    var price = priceData[i];

                    // Check if latitude, longitude, name, and price are valid
                    if (!isNaN(latitude) && !isNaN(longitude) && name && !isNaN(price)) {
                        var marker = L.marker([latitude, longitude]).bindPopup('<b>' + name + '</b><br>Price: ' + price + ' EUR');
                        markers.push(marker);

                        // Draw line between markers except for the last one
                        if (i > 0) {
                            var prevLat = parseFloat(latitudeData[i - 1]);
                            var prevLon = parseFloat(longitudeData[i - 1]);
                            var line = L.polyline([[prevLat, prevLon], [latitude, longitude]], { color: 'blue' }).addTo(map);
                        }
                    } else {
                        console.error('Invalid data at index', i);
                    }
                }
                // Add all markers to the map
                var markerGroup = L.layerGroup(markers);
                markerGroup.addTo(map);

                // Animate balls between markers
                for (var i = 1; i < markers.length; i++) {
                    var prevMarker = markers[i - 1];
                    var currentMarker = markers[i];
                    animateBall(prevMarker.getLatLng(), currentMarker.getLatLng());
                }
            } else {
                console.error('Latitude, longitude, names, and price data must be arrays of the same length');
            }
        } else {
            console.error('Latitude, longitude, names, and price data must be arrays');
        }
    } catch (error) {
        console.error('An error occurred while adding markers:', error);
    }

    // Function to animate ball between two points
    function animateBall(startLatLng, endLatLng) {
        var startRadius = 1; // Starting radius of the ball
        var maxRadius = 5; // Maximum radius of the ball
        var ball = L.circleMarker(startLatLng, { radius: startRadius, color: 'lightblue', fillOpacity: 1 }).addTo(map);
        var duration = 3000; // Duration of animation in milliseconds

        function animate() {
            var t = Date.now() - startTime;
            var fraction = t / duration;
            var interpolatedLatLng = L.latLng(
                startLatLng.lat + (endLatLng.lat - startLatLng.lat) * fraction,
                startLatLng.lng + (endLatLng.lng - startLatLng.lng) * fraction
            );

            var interpolatedRadius = startRadius + (maxRadius - startRadius) * fraction;
            ball.setLatLng(interpolatedLatLng);
            ball.setRadius(interpolatedRadius);

            if (fraction < 1) {
                requestAnimationFrame(animate);
            } else {
                startTime = Date.now(); // Restart the animation
                ball.setLatLng(startLatLng);
                ball.setRadius(startRadius);
                animate(); // Continue the animation
            }
        }

        var startTime = Date.now();
        animate();
    }
</script>





    <!-- Load custom CSS styles -->
    <link rel="stylesheet" href="{{ url_for('static', filename='styles.css') }}">
</body>
</html>
